<app-page-header>Статистика каналов</app-page-header>

<div class="container my-5">
  <!-- Channels Section -->
  <div class="row mb-4">
    <div class="col">
      <h5>Каналы</h5>
      <button class="btn btn-primary mb-3" (click)="create()">
        <i class="bi bi-plus-circle me-2"></i>
        Добавить канал
      </button>
    </div>
  </div>

  <div class="card mb-5" *ngIf="channels; else dataLoading">
    <div
      class="card-body p-3"
      *ngIf="channels.length > 0; else noChannels"
    >
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr class="small">
              <th>Название</th>
              <th>Channel ID</th>
              <th>Discussion Chat ID</th>
              <th>Активен</th>
              <th>Создан</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of channels" class="small">
              <td>{{ item.channelName }}</td>
              <td>
                <code>{{ item.channelExternalId }}</code>
              </td>
              <td>
                <code *ngIf="item.discussionChatExternalId">{{
                  item.discussionChatExternalId
                }}</code>
                <span
                  *ngIf="!item.discussionChatExternalId"
                  class="text-muted"
                  >—</span
                >
              </td>
              <td>
                <span
                  class="badge"
                  [ngClass]="
                    item.isActive ? 'bg-success' : 'bg-secondary'
                  "
                >
                  {{ item.isActive ? "Да" : "Нет" }}
                </span>
              </td>
              <td>{{ item.createdAt | date: "yyyy-MM-dd HH:mm" }}</td>
              <td>
                <div class="btn-group" role="group">
                  <button
                    type="button"
                    class="btn btn-outline-dark dropdown-toggle btn-sm"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    Действия
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <button
                        type="button"
                        class="dropdown-item"
                        (click)="edit(item)"
                      >
                        Редактировать
                      </button>
                    </li>
                    <li>
                      <button
                        type="button"
                        class="dropdown-item"
                        (click)="calculateStats(item)"
                        [disabled]="calculatingChannelId === item.id"
                      >
                        {{ calculatingChannelId === item.id ? "Расчет..." : "Рассчитать статистику" }}
                      </button>
                    </li>
                    <li>
                      <button
                        type="button"
                        class="dropdown-item"
                        (click)="openSendDialog(item)"
                      >
                        Отправить обновление
                      </button>
                    </li>
                    <li><hr class="dropdown-divider" /></li>
                    <li>
                      <button
                        type="button"
                        class="dropdown-item"
                        [ngClass]="item.isActive ? 'text-danger' : 'text-success'"
                        (click)="toggleActive(item)"
                      >
                        {{ item.isActive ? "Отключить" : "Включить" }}
                      </button>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Run Stats Section -->
  <div class="row mb-4">
    <div class="col">
      <h5>Запуск статистики</h5>
      <button
        class="btn btn-warning"
        (click)="runStats()"
        [disabled]="runInProgress"
      >
        <i
          class="bi me-2"
          [ngClass]="
            runInProgress ? 'bi-hourglass-split' : 'bi-play-circle'
          "
        ></i>
        {{ runInProgress ? "Расчет..." : "Рассчитать сейчас" }}
      </button>
    </div>
  </div>

  <div class="card mb-5" *ngIf="lastRunResponse">
    <div class="card-body p-3">
      <h6>Результат запуска</h6>
      <p class="mb-1">
        Рассчитано каналов: {{ lastRunResponse.runs.length }}
      </p>
      <p
        class="mb-0"
        *ngIf="lastRunResponse.errors.length > 0"
      >
        Ошибки:
      </p>
      <ul *ngIf="lastRunResponse.errors.length > 0" class="mb-0">
        <li *ngFor="let err of lastRunResponse.errors">
          <strong>{{ err.channelName }}</strong
          >: {{ err.errorMessage }}
        </li>
      </ul>
    </div>
  </div>

  <!-- Results Section -->
  <div class="row mb-3">
    <div class="col">
      <h5>Результаты за месяц</h5>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-auto">
      <label class="form-label">Год</label>
      <input
        type="number"
        class="form-control"
        [(ngModel)]="resultsYear"
        min="2020"
        max="2099"
        style="width: 120px"
      />
    </div>
    <div class="col-auto">
      <label class="form-label">Месяц</label>
      <input
        type="number"
        class="form-control"
        [(ngModel)]="resultsMonth"
        min="1"
        max="12"
        style="width: 100px"
      />
    </div>
    <div class="col-auto d-flex align-items-end">
      <button
        class="btn btn-outline-primary"
        (click)="loadResults()"
        [disabled]="resultsLoading"
      >
        <i class="bi bi-search me-1"></i>
        Загрузить
      </button>
    </div>
  </div>

  <div *ngIf="resultsLoading" class="mb-5">
    <app-data-loader></app-data-loader>
  </div>

  <div
    class="card mb-5"
    *ngIf="statsResults && !resultsLoading"
  >
    <div
      class="card-body p-3"
      *ngIf="statsResults.length > 0; else noResults"
    >
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr class="small">
              <th>Канал ID</th>
              <th>Постов</th>
              <th>Среднее/день</th>
              <th>Макс. лайков</th>
              <th>Макс. комментариев</th>
              <th>Макс. постов/день</th>
              <th>Мин. постов/день</th>
              <th>Источник</th>
              <th>Дата расчета</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let run of statsResults" class="small">
              <td>{{ run.monitoredChannelId }}</td>
              <td>{{ run.postsCountTotal }}</td>
              <td>{{ run.averagePostsPerDay | number: "1.1-1" }}</td>
              <td>
                <span *ngIf="run.mostLikedPostLikes !== null">
                  {{ run.mostLikedPostLikes }}
                  <a
                    *ngIf="run.mostLikedPostRef"
                    [href]="run.mostLikedPostRef"
                    target="_blank"
                    class="ms-1"
                    title="Открыть пост"
                  >
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                </span>
                <span *ngIf="run.mostLikedPostLikes === null" class="text-muted">—</span>
              </td>
              <td>
                <span *ngIf="run.mostCommentedPostComments !== null">
                  {{ run.mostCommentedPostComments }}
                  <a
                    *ngIf="run.mostCommentedPostRef"
                    [href]="run.mostCommentedPostRef"
                    target="_blank"
                    class="ms-1"
                    title="Открыть пост"
                  >
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                </span>
                <span *ngIf="run.mostCommentedPostComments === null" class="text-muted">—</span>
              </td>
              <td>
                <span *ngIf="run.maxPostsDayUtc">
                  {{ run.maxPostsCount }} ({{
                    run.maxPostsDayUtc | date: "dd.MM"
                  }})
                </span>
                <span *ngIf="!run.maxPostsDayUtc" class="text-muted">—</span>
              </td>
              <td>
                <span *ngIf="run.minPostsDayUtc">
                  {{ run.minPostsCount }} ({{
                    run.minPostsDayUtc | date: "dd.MM"
                  }})
                </span>
                <span *ngIf="!run.minPostsDayUtc" class="text-muted">—</span>
              </td>
              <td>{{ run.triggerSourceAsString }}</td>
              <td>
                {{ run.calculatedAtUtc | date: "yyyy-MM-dd HH:mm" }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<ng-template #noChannels>
  <div class="card-body text-center text-muted">
    Каналы не найдены.
  </div>
</ng-template>

<ng-template #noResults>
  <div class="card-body text-center text-muted">
    Результатов за этот месяц нет.
  </div>
</ng-template>

<ng-template #dataLoading>
  <div class="container mt-5">
    <app-data-loader></app-data-loader>
  </div>
</ng-template>

<!-- Edit/Create Channel Modal -->
<app-dialog
  [show]="!!editForm"
  (closed)="onEditModalDlgClose()"
  [header]="itemToEdit ? 'Редактировать канал' : 'Добавить канал'"
>
  <form
    *ngIf="!!editForm"
    class="mb-3"
    [formGroup]="editForm"
    (ngSubmit)="onEditFormSubmit()"
  >
    <div class="mb-3" *ngIf="!itemToEdit">
      <label class="form-label"
        >Channel External ID <span class="text-danger">*</span></label
      >
      <input
        type="number"
        class="form-control"
        formControlName="channelExternalId"
        placeholder="-1001234567890"
      />
      <app-field-error
        [field]="editForm.get('channelExternalId')"
      ></app-field-error>
    </div>

    <div class="mb-3">
      <label class="form-label"
        >Название канала <span class="text-danger">*</span></label
      >
      <input
        type="text"
        class="form-control"
        formControlName="channelName"
        placeholder="My Channel"
      />
      <app-field-error
        [field]="editForm.get('channelName')"
      ></app-field-error>
    </div>

    <div class="mb-3">
      <label class="form-label">Discussion Chat External ID</label>
      <input
        type="number"
        class="form-control"
        formControlName="discussionChatExternalId"
        placeholder="-1009876543210"
      />
    </div>

    <div class="mb-3 form-check" *ngIf="itemToEdit">
      <input
        type="checkbox"
        class="form-check-input"
        formControlName="isActive"
        id="isActiveCheck"
      />
      <label class="form-check-label" for="isActiveCheck">Активен</label>
    </div>

    <div class="d-flex justify-content-end">
      <button
        type="button"
        class="btn btn-secondary me-2"
        (click)="onEditModalDlgClose()"
      >
        Отмена
      </button>
      <button type="submit" class="btn btn-primary">
        {{ itemToEdit ? "Обновить" : "Создать" }}
      </button>
    </div>
  </form>
</app-dialog>

<!-- Send Stats Run Modal -->
<app-dialog
  [show]="!!sendDialogChannel"
  (closed)="closeSendDialog()"
  [header]="'Отправить обновление — ' + (sendDialogChannel?.channelName ?? '')"
>
  <div *ngIf="sendDialogLoading" class="text-center py-3">
    <app-data-loader></app-data-loader>
  </div>

  <div *ngIf="!sendDialogLoading && sendDialogRuns?.length === 0" class="text-center text-muted py-3">
    Нет доступных расчетов для этого канала.
  </div>

  <div *ngIf="!sendDialogLoading && sendDialogRuns && sendDialogRuns.length > 0">
    <div class="mb-3">
      <label class="form-label" for="sendRunSelect">Выберите расчет</label>
      <select
        id="sendRunSelect"
        class="form-select"
        [(ngModel)]="sendDialogSelectedRunId"
      >
        <option
          *ngFor="let run of sendDialogRuns"
          [ngValue]="run.id"
        >
          {{ run.month | date: "MMMM yyyy" }} — {{ run.postsCountTotal }} постов ({{ run.calculatedAtUtc | date: "dd.MM.yyyy HH:mm" }})
        </option>
      </select>
    </div>

    <div class="d-flex justify-content-end">
      <button
        type="button"
        class="btn btn-secondary me-2"
        (click)="closeSendDialog()"
      >
        Отмена
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="sendSelectedRun()"
        [disabled]="sendInProgress || sendDialogSelectedRunId == null"
      >
        {{ sendInProgress ? "Отправка..." : "Отправить" }}
      </button>
    </div>
  </div>
</app-dialog>
