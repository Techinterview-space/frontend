<app-page-header>
  <div class="profile-container profile-header">
    <div class="profile-avatar-wrapper">
      <img
        *ngIf="user?.pictureProfile"
        [src]="user?.pictureProfile"
        class="profile-avatar"
        alt="Profile picture"
      />
      <img
        *ngIf="!user?.pictureProfile"
        src="https://via.placeholder.com/120"
        class="profile-avatar"
        alt="Profile picture placeholder"
      />
    </div>
    <div class="profile-info">
      <h1 class="profile-name">{{ user?.fullName }}</h1>
    </div>
  </div>
</app-page-header>

<div class="profile-container mt-4 mb-5" *ngIf="user; else dataLoading">
  <div class="row g-4">
    <!-- Personal Information Card -->
    <div class="col-lg-6">
      <div class="card profile-card h-100">
        <div class="card-header profile-card-header">
          <i class="bi bi-person-circle me-2"></i>
          <span>Личная информация</span>
        </div>
        <div class="card-body">
          <div class="info-item">
            <div class="info-label">
              <i class="bi bi-envelope me-2"></i>
              <span>Email</span>
            </div>
            <div class="info-value">
              {{ user.email ?? "-" }}
            </div>
            <div class="info-status" *ngIf="!user.emailConfirmed">
              <span class="badge bg-warning text-dark">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Email не подтвержден
              </span>
            </div>
          </div>
          <div class="info-item" *ngIf="user && user.roles != null && user.roles.length > 0">
            <div class="info-label">
              <i class="bi bi-person-badge me-2"></i>
              <span>Роли</span>
            </div>
            <div class="info-value">
              <app-user-roles-label
                [userRoles]="user.roles">
              </app-user-roles-label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Security Settings Card -->
    <div class="col-lg-6">
      <div class="card profile-card h-100">
        <div class="card-header profile-card-header">
          <i class="bi bi-shield-lock me-2"></i>
          <span>Безопасность</span>
        </div>
        <div class="card-body">
          <div class="info-item">
            <div class="info-label">
              <i class="bi bi-key me-2"></i>
              <span>Мультифакторная аутентификация (MFA)</span>
            </div>
            <div class="info-value" *ngIf="user.isMfaEnabled">
              <span class="badge bg-success text-light me-2">
                <i class="bi bi-check-circle me-1"></i>
                Включена
              </span>
              <button
                type="button"
                class="btn btn-outline-danger btn-sm mt-2"
                (click)="openDisableMfaDialog()"
              >
                <i class="bi bi-x-circle me-1"></i>
                Отключить MFA
              </button>
            </div>
            <div class="info-value" *ngIf="!user.isMfaEnabled">
              <span class="badge bg-secondary text-light me-2">
                <i class="bi bi-x-circle me-1"></i>
                Отключена
              </span>
              <button
                type="button"
                class="btn btn-outline-primary btn-sm mt-2"
                (click)="openMfaSetupDialog()"
              >
                <i class="bi bi-shield-check me-1"></i>
                Настроить MFA
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Email Preferences Card -->
    <div class="col-lg-12">
      <div class="card profile-card">
        <div class="card-header profile-card-header">
          <i class="bi bi-bell me-2"></i>
          <span>Настройки уведомлений</span>
        </div>
        <div class="card-body">
          <div class="info-item">
            <div class="info-label">
              <i class="bi bi-envelope-check me-2"></i>
              <span>Отписка от всех email</span>
            </div>
            <div class="info-value">
              <span
                *ngIf="user.unsubscribeMeFromAll"
                class="badge bg-warning text-dark"
              >
                <i class="bi bi-toggle-on me-1"></i>
                Отписаны
              </span>
              <span *ngIf="!user.unsubscribeMeFromAll" class="badge bg-success">
                <i class="bi bi-toggle-off me-1"></i>
                Подписаны
              </span>
            </div>
            <div class="info-description">
              <div class="alert alert-light mt-3 mb-0">
                <p class="mb-2">
                  <strong><i class="bi bi-info-circle me-2"></i>Когда мы отправляем email:</strong>
                </p>
                <ul class="mb-2">
                  <li>Аппрув/реджект оставленного отзыва на компанию</li>
                  <li>Напоминание об зарплатной анкете годичной давности</li>
                </ul>
                <p class="mb-0">
                  <i class="bi bi-shield-check me-1"></i>
                  <strong>Важно:</strong> Никаких рекламных email сервис никогда не отправит.
                </p>
                <p class="mb-0 mt-2">
                  Если вы хотите отписаться от всех email, то можете сделать это в следующем пришедшем письме.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Salaries Section -->
    <div class="col-lg-12">
      <div class="card profile-card">
        <div class="card-header profile-card-header">
          <i class="bi bi-cash-stack me-2"></i>
          <span>Отправленные анкеты</span>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-end mb-3" *ngIf="mySalaries != null && mySalaries.length > 0">
            <button
              type="button"
              class="btn btn-outline-secondary btn-sm"
              (click)="toggleBlurTable()"
            >
              <i class="bi" [class.bi-eye]="blurTable" [class.bi-eye-slash]="!blurTable" class="me-1"></i>
              {{ blurTable ? "Показать" : "Скрыть" }} зарплаты
            </button>
          </div>
          <div
            class="table-responsive"
            *ngIf="mySalaries != null && mySalaries.length > 0"
          >
            <table class="table table-hover salaries-table" [class.blur]="blurTable">
              <thead>
                <tr>
                  <th>Зарплата</th>
                  <th>Период</th>
                  <th>Специальность</th>
                  <th>Грейд</th>
                  <th>Компания</th>
                  <th>Город</th>
                  <th>Навык</th>
                  <th>Сфера</th>
                  <th>Добавлено</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of mySalaries; let i = index">
                  <td class="salary-value">
                    <strong>{{ item.value | formatAsMoney }}</strong>
                  </td>
                  <td>{{ item.quarter }}.{{ item.year }}</td>
                  <td>{{ item.profession }}</td>
                  <td>
                    <app-developer-grade-label
                      [grade]="item.gradeAsEnum"
                    ></app-developer-grade-label>
                  </td>
                  <td>{{ item.company }}</td>
                  <td>{{ item.city }}</td>
                  <td>{{ item.skill }}</td>
                  <td>{{ item.industry }}</td>
                  <td class="text-muted small">
                    {{ item.createdAt | date: "yyyy-MM-dd HH:mm" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div
            *ngIf="mySalaries != null && mySalaries.length === 0"
            class="empty-state"
          >
            <div class="text-center py-5">
              <i class="bi bi-inbox empty-state-icon"></i>
              <p class="mt-3 text-muted">
                Вы еще не отправляли зарплаты в статистику.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #dataLoading>
  <div class="profile-container mt-5">
    <app-data-loader></app-data-loader>
  </div>
</ng-template>

<app-dialog
  [show]="!!mfaQrCodeImage"
  (closed)="onQrModalDlgClose()"
  [header]="'Просканируйте QR для добавления MFA'"
  [additionalCss]="'modal-lg'"
>
  <div class="text-center">
    <img [src]="mfaQrCodeImage" class="img-fluid" alt="QR code" />
  </div>
</app-dialog>

<app-confirm-dialog
  *ngIf="confirmDisablingMfaMessage"
  [message]="confirmDisablingMfaMessage"
></app-confirm-dialog>
