<app-page-header>
  Мои опросы
</app-page-header>

<div class="container mt-5 mb-5">
  <!-- Toolbar -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <!-- Status filter tabs -->
      <div class="btn-group btn-group-sm" role="group" aria-label="Фильтр по статусу">
        <button
          class="btn"
          [ngClass]="activeFilter === 'all' ? 'btn-primary' : 'btn-outline-primary'"
          (click)="setFilter('all')"
        >Все</button>
        <button
          class="btn"
          [ngClass]="activeFilter === 'draft' ? 'btn-primary' : 'btn-outline-primary'"
          (click)="setFilter('draft')"
        >Черновики</button>
        <button
          class="btn"
          [ngClass]="activeFilter === 'published' ? 'btn-primary' : 'btn-outline-primary'"
          (click)="setFilter('published')"
        >Опубликованные</button>
        <button
          class="btn"
          [ngClass]="activeFilter === 'closed' ? 'btn-primary' : 'btn-outline-primary'"
          (click)="setFilter('closed')"
        >Закрытые</button>
      </div>

      <!-- Show deleted toggle -->
      <div class="form-check ms-2">
        <input
          type="checkbox"
          class="form-check-input"
          id="showDeleted"
          [checked]="showDeleted"
          (change)="toggleShowDeleted()"
        />
        <label class="form-check-label text-muted small" for="showDeleted">
          Показать удалённые
        </label>
      </div>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <!-- Search -->
      <input
        type="text"
        class="form-control form-control-sm"
        placeholder="Поиск по названию..."
        [(ngModel)]="searchQuery"
        style="max-width: 220px"
      />

      <!-- Create button -->
      <a routerLink="/surveys/new" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-lg"></i> Создать
      </a>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading">
    <app-data-loader></app-data-loader>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && filteredSurveys.length === 0" class="text-center py-5">
    <p class="text-muted">
      <span *ngIf="surveys.length === 0">У вас пока нет опросов.</span>
      <span *ngIf="surveys.length > 0">Нет опросов по выбранным фильтрам.</span>
    </p>
    <a *ngIf="surveys.length === 0" routerLink="/surveys/new" class="btn btn-primary">
      Создать первый опрос
    </a>
  </div>

  <!-- Survey list -->
  <div *ngIf="!loading && filteredSurveys.length > 0" class="row">
    <div
      class="col-md-6 col-lg-4 mb-4"
      *ngFor="let item of filteredSurveys"
    >
      <div
        class="card h-100"
        [class.border-danger]="isDeleted(item)"
        [class.opacity-75]="isDeleted(item)"
      >
        <div class="card-body d-flex flex-column">
          <!-- Header: title + badges -->
          <div class="mb-2">
            <span class="badge me-1" [ngClass]="statusBadgeClass(item)">
              {{ statusLabel(item.status) }}
            </span>
            <span *ngIf="isDeleted(item)" class="badge bg-danger">
              Удалён
            </span>
          </div>

          <h5 class="card-title mb-2">
            <a
              *ngIf="!isDraft(item)"
              [routerLink]="['/surveys', item.slug]"
              class="text-decoration-none"
            >{{ item.title }}</a>
            <span *ngIf="isDraft(item)">{{ item.title }}</span>
          </h5>

          <!-- Stats -->
          <div class="text-muted small mb-3">
            <div>
              <i class="bi bi-chat-dots" aria-hidden="true"></i>
              Ответов: {{ item.totalResponses }}
            </div>
            <div>
              <i class="bi bi-calendar" aria-hidden="true"></i>
              Создан: {{ item.createdAt | date: 'dd.MM.yyyy' }}
            </div>
            <div *ngIf="item.publishedAt">
              <i class="bi bi-send" aria-hidden="true"></i>
              Опубликован: {{ item.publishedAt | date: 'dd.MM.yyyy' }}
            </div>
          </div>

          <!-- Spacer to push actions to bottom -->
          <div class="mt-auto">
            <!-- Results link -->
            <a
              *ngIf="item.totalResponses > 0 && !isDraft(item)"
              [routerLink]="['/surveys', item.slug, 'results']"
              class="btn btn-outline-secondary btn-sm me-1 mb-1"
            >
              <i class="bi bi-bar-chart" aria-hidden="true"></i> Результаты
            </a>

            <!-- Actions -->
            <a
              *ngIf="isDraft(item) && !isDeleted(item)"
              [routerLink]="['/surveys', item.slug, 'edit']"
              class="btn btn-outline-primary btn-sm me-1 mb-1"
            >
              <i class="bi bi-pencil" aria-hidden="true"></i> Редактировать
            </a>

            <button
              *ngIf="isDraft(item) && !isDeleted(item)"
              class="btn btn-success btn-sm me-1 mb-1"
              (click)="publish(item)"
            >
              <i class="bi bi-send" aria-hidden="true"></i> Опубликовать
            </button>

            <button
              *ngIf="isPublished(item) && !isDeleted(item)"
              class="btn btn-warning btn-sm me-1 mb-1"
              (click)="close(item)"
            >
              <i class="bi bi-stop-circle" aria-hidden="true"></i> Закрыть
            </button>

            <button
              *ngIf="isClosed(item) && !isDeleted(item)"
              class="btn btn-success btn-sm me-1 mb-1"
              (click)="reopen(item)"
            >
              <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> Открыть
            </button>

            <button
              *ngIf="!isDeleted(item)"
              class="btn btn-outline-danger btn-sm me-1 mb-1"
              (click)="deleteSurvey(item)"
              aria-label="Удалить опрос"
            >
              <i class="bi bi-trash" aria-hidden="true"></i>
            </button>

            <button
              *ngIf="isDeleted(item)"
              class="btn btn-outline-success btn-sm me-1 mb-1"
              (click)="restore(item)"
            >
              <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> Восстановить
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
